<script type="text/javascript">
        let allProducts = [];
        
        // --- CONFIGURAÇÃO DA LOJA ---
        const WHATSAPP_LOJA = "5521999999999"; 
        
        // --- CONFIGURAÇÃO SUPABASE ---
        const SUPABASE_URL = 'https://oixxpvupokedqfetyarz.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9peHhwdnVwb2tlZHFmZXR5YXJ6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMyNDc0OTMsImV4cCI6MjA3ODgyMzQ5M30.rJthexTj2qtKPVQ2ogQrMHjFT-w0HmVlrq7JVMe6eQU';

        document.getElementById('current-year').textContent = new Date().getFullYear();

        async function loadData() {
            try {
                console.log("Iniciando busca de dados no Supabase...");
                const response = await fetch(`${SUPABASE_URL}/rest/v1/produtos?select=*`, {
                    headers: {
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                const data = await response.json();
                console.log("Dados recebidos do Banco:", data); // Verifique isso no F12 -> Console
                
                if (!Array.isArray(data) || data.length === 0) {
                    console.warn("Atenção: O banco retornou uma lista vazia ou erro.");
                }

                allProducts = data.map((p, index) => ({
                    ...p,
                    id: p.id !== undefined && p.id !== null ? p.id : index
                }));

                setupFilters(allProducts);
                renderProducts(allProducts); // Força a exibição inicial sem filtros

            } catch (error) {
                console.error('Erro Crítico na Carga:', error);
                document.getElementById('products-grid').innerHTML = `
                    <div class="col-span-full p-8 bg-red-50 border border-red-200 rounded-xl text-center">
                        <p class="text-red-600 font-bold">Erro ao carregar produtos!</p>
                        <p class="text-red-500 text-sm">${error.message}</p>
                    </div>
                `;
            }
        }

        function renderProducts(products) {
            const grid = document.getElementById('products-grid');
            const msg = document.getElementById('no-products-message');
            grid.innerHTML = '';
            
            if (!products || products.length === 0) {
                msg.classList.remove('hidden');
                return;
            }
            msg.classList.add('hidden');

            products.forEach(p => {
                const card = document.createElement('div');
                card.className = 'product-card bg-white rounded-2xl shadow-sm border border-gray-100 flex flex-col h-full overflow-hidden';
                card.innerHTML = `
                    <div class="h-64 bg-gray-50 flex items-center justify-center p-6 relative">
                        <img src="${p.url_imagem}" class="max-h-full max-w-full object-contain" 
                             onerror="this.src='https://placehold.co/400x400?text=Sem+Foto';">
                    </div>
                    <div class="p-6 flex flex-col flex-grow">
                        <span class="text-[10px] uppercase font-black text-indigo-500 mb-1">${p.marca || 'Celular'}</span>
                        <h3 class="font-bold text-lg text-gray-900 leading-tight mb-2">${p.nome || 'Produto sem nome'}</h3>
                        <p class="text-gray-500 text-xs line-clamp-3 italic flex-grow mb-4">"${p.descricao || ''}"</p>
                        
                        <div class="border-t pt-4">
                            <span class="text-gray-400 text-[10px] block uppercase font-bold">Valor à vista</span>
                            <span class="text-2xl font-black text-indigo-700">R$ ${parseFloat(p.preco || 0).toLocaleString('pt-BR', {minimumFractionDigits: 2})}</span>
                            
                            <button onclick="createWhatsappLink('${p.id}')" 
                                    class="w-full mt-4 bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-xl transition flex items-center justify-center gap-2">
                                RESERVAR AGORA
                            </button>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Funções auxiliares (setupFilters, applyFilters, etc) permanecem as mesmas
        function setupFilters(products) {
            const brands = [...new Set(products.map(p => p.marca).filter(Boolean))].sort();
            const container = document.getElementById('brand-filters');
            container.innerHTML = brands.map(brand => `
                <label class="flex items-center space-x-2 cursor-pointer group">
                    <input type="checkbox" name="brand" value="${brand}" onchange="applyFilters()" class="w-4 h-4 rounded border-gray-300">
                    <span class="text-gray-600">${brand}</span>
                </label>
            `).join('');

            const prices = products.map(p => parseFloat(p.preco) || 0);
            const max = Math.max(...prices, 1000);
            const priceRange = document.getElementById('priceRange');
            priceRange.max = max;
            priceRange.value = max;
            updatePriceDisplay(max);
        }

        function updatePriceDisplay(val) {
            document.getElementById('maxPriceDisplay').textContent = `R$ ${parseFloat(val).toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchBar').value.toLowerCase();
            const maxPrice = parseFloat(document.getElementById('priceRange').value);
            const selectedBrands = Array.from(document.querySelectorAll('input[name="brand"]:checked')).map(cb => cb.value);

            const filtered = allProducts.filter(p => {
                const matchSearch = (p.nome || "").toLowerCase().includes(searchTerm);
                const matchBrand = selectedBrands.length === 0 || selectedBrands.includes(p.marca);
                const matchPrice = parseFloat(p.preco || 0) <= maxPrice;
                return matchSearch && matchBrand && matchPrice;
            });
            renderProducts(filtered);
        }

        function createWhatsappLink(id) {
            const p = allProducts.find(prod => prod.id == id);
            if (!p) return;
            const msg = `Olá! Gostaria de saber a disponibilidade do: ${p.nome}`;
            window.open(`https://wa.me/${WHATSAPP_LOJA}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        function clearFilters() {
            document.getElementById('searchBar').value = '';
            document.querySelectorAll('input[name="brand"]').forEach(c => c.checked = false);
            applyFilters();
        }

        window.onload = loadData;
    </script>
